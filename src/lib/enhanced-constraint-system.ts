/**
 * ENHANCED CONSTRAINT ENFORCEMENT SYSTEM FOR PRODUCTION QUALITY
 * 
 * This system implements multi-layered constraint enforcement specifically designed
 * to eliminate the critical quality issues identified in production:
 * 
 * 1. NO HUMANS - Zero tolerance for any human elements
 * 2. NO IRRELEVANT OBJECTS - Systematic prevention of unrelated items
 * 3. NO ARTIFACTS - Technical constraints for photorealistic output
 * 4. STRICT ADHERENCE - Enforced compliance with user specifications
 */

import { ContextPreset, UiSettings, ProductSpecs } from '@/components/image-generator/types';
import { ProductIntelligence, PlacementType, MaterialType } from '@/lib/gemini-prompt-engine';

// Constraint Enforcement Levels
export enum ConstraintLevel {
  ABSOLUTE = 'ABSOLUTE',        // Zero tolerance - generation fails if violated
  CRITICAL = 'CRITICAL',        // Multiple enforcement layers
  HIGH = 'HIGH',               // Strong emphasis with validation
  MEDIUM = 'MEDIUM'            // Standard enforcement
}

// Production Quality Issues - Systematic Prevention
export interface QualityIssue {
  category: 'humans' | 'objects' | 'artifacts' | 'placement' | 'adherence';
  severity: ConstraintLevel;
  description: string;
  prevention: string[];
  validation: string[];
}

/**
 * COMPREHENSIVE QUALITY ISSUE PREVENTION SYSTEM
 */
export class EnhancedConstraintSystem {
  
  /**
   * Build multi-layered constraint enforcement block
   */
  static buildEnhancedConstraints(
    specs: ProductSpecs,
    contextPreset: ContextPreset,
    settings: UiSettings,
    productIntel: ProductIntelligence
  ): string {
    
    const constraints = [
      this.buildHumanElementPrevention(),
      this.buildIrrelevantObjectPrevention(contextPreset, settings),
      this.buildArtifactPrevention(),
      this.buildPlacementEnforcement(productIntel),
      this.buildAdherenceEnforcement(specs, settings),
      this.buildContextSpecificConstraints(contextPreset, settings),
      this.buildValidationRequirements()
    ];

    return constraints.join('\n\n');
  }

  /**
   * CRITICAL: Human Element Prevention (Issue #1)
   * Zero tolerance for any human presence or representation
   */
  private static buildHumanElementPrevention(): string {
    return `üö´üë• ABSOLUTE HUMAN ELEMENT PROHIBITION - ZERO TOLERANCE

‚õî PRIMARY HUMAN PROHIBITIONS:
‚Ä¢ NO humans, people, persons of any age, gender, or ethnicity
‚Ä¢ NO human faces, heads, or facial features
‚Ä¢ NO human hands, arms, legs, feet, or any body parts
‚Ä¢ NO human torso, chest, back, or body silhouettes
‚Ä¢ NO human shadows, outlines, or partial human forms

‚õî EXTENDED HUMAN ELEMENT PROHIBITIONS:
‚Ä¢ NO human clothing, garments, or personal accessories
‚Ä¢ NO shoes, boots, socks, or footwear of any kind
‚Ä¢ NO jewelry, watches, glasses, or personal items
‚Ä¢ NO handbags, purses, backpacks, or personal bags
‚Ä¢ NO human hair, wigs, or hair accessories

‚õî HUMAN ACTIVITY PROHIBITIONS:
‚Ä¢ NO human positioning or staging suggestions
‚Ä¢ NO items arranged as if humans were present
‚Ä¢ NO human-scale reference objects (except architectural elements)
‚Ä¢ NO lifestyle staging that implies recent human use
‚Ä¢ NO personal workspace arrangements suggesting human activity

‚õî HUMAN REPRESENTATION PROHIBITIONS:
‚Ä¢ NO mannequins, dolls, or humanoid figures
‚Ä¢ NO human artwork, portraits, or representations
‚Ä¢ NO human-themed decorative elements
‚Ä¢ NO anthropomorphic designs or human-like features

VALIDATION REQUIREMENT: The final image must be completely devoid of any human presence, suggestion, or representation. Any hint of human elements constitutes immediate generation failure.`;
  }

  /**
   * CRITICAL: Irrelevant Object Prevention (Issue #2) 
   * Systematic elimination of unrelated objects and props
   */
  private static buildIrrelevantObjectPrevention(contextPreset: ContextPreset, settings: UiSettings): string {
    const approvedProps = settings.props && settings.props.length > 0 ? 
      settings.props.join(', ') : 'NONE';

    return `üö´üóëÔ∏è IRRELEVANT OBJECT ELIMINATION - SYSTEMATIC PREVENTION

‚õî DINING & KITCHEN ITEM PROHIBITIONS:
‚Ä¢ NO cups, mugs, glasses, or drinking vessels
‚Ä¢ NO plates, bowls, dishes, or serving ware
‚Ä¢ NO utensils, cutlery, or dining implements
‚Ä¢ NO food items, snacks, or consumables
‚Ä¢ NO napkins, placemats, or dining accessories
‚Ä¢ NO coffee pots, tea sets, or beverage equipment

‚õî PERSONAL ITEM PROHIBITIONS:
‚Ä¢ NO books, magazines, newspapers, or reading materials
‚Ä¢ NO phones, tablets, laptops, or electronic devices
‚Ä¢ NO stationery, pens, papers, or office supplies
‚Ä¢ NO remote controls, chargers, or tech accessories
‚Ä¢ NO personal care items or toiletries
‚Ä¢ NO games, toys, or recreational objects

‚õî DECORATIVE OBJECT PROHIBITIONS:
‚Ä¢ NO vases, pottery, or decorative containers (unless approved)
‚Ä¢ NO candles, candle holders, or flame objects
‚Ä¢ NO picture frames or artwork (unless environmental)
‚Ä¢ NO sculptures, figurines, or decorative objects
‚Ä¢ NO clocks, mirrors, or wall hangings (unless environmental)
‚Ä¢ NO seasonal decorations or holiday items

‚õî TEXTILE & SOFT FURNISHING PROHIBITIONS:
‚Ä¢ NO throw pillows, cushions, or decorative pillows
‚Ä¢ NO blankets, throws, or bed linens
‚Ä¢ NO rugs, carpets, or floor coverings (unless environmental)
‚Ä¢ NO curtains, drapes, or window treatments (unless environmental)
‚Ä¢ NO tablecloths, runners, or surface textiles

‚õî PLANT & ORGANIC PROHIBITIONS:
‚Ä¢ NO plants, flowers, or greenery (unless specifically approved)
‚Ä¢ NO vines, branches, or organic decorative elements
‚Ä¢ NO potted plants, planters, or gardening items
‚Ä¢ NO floral arrangements or botanical decorations

‚õî LIGHTING FIXTURE PROHIBITIONS:
‚Ä¢ NO table lamps, floor lamps, or portable lighting (unless approved)
‚Ä¢ NO pendant lights, chandeliers, or overhead fixtures (unless environmental)
‚Ä¢ NO candles, oil lamps, or flame-based lighting
‚Ä¢ NO decorative lighting or string lights

APPROVED PROPS FOR THIS GENERATION: ${approvedProps}
CONSTRAINT: Only items explicitly listed as approved props may appear in the scene. All other objects are strictly prohibited.

VALIDATION REQUIREMENT: Every object in the scene must serve the furniture presentation purpose. No extraneous, decorative, or unrelated items permitted.`;
  }

  /**
   * CRITICAL: Artifact Prevention (Issue #3)
   * Technical constraints for photorealistic, professional output
   */
  private static buildArtifactPrevention(): string {
    return `üö´üé® PHOTOGRAPHIC ARTIFACT PREVENTION - TECHNICAL QUALITY CONTROL

‚õî RENDERING ARTIFACT PROHIBITIONS:
‚Ä¢ NO cartoon-like, animated, or non-photorealistic rendering
‚Ä¢ NO sketch-like, drawing-like, or artistic interpretation
‚Ä¢ NO painted, watercolor, or artistic effects
‚Ä¢ NO 3D render appearance or computer-generated look
‚Ä¢ NO unrealistic lighting or impossible shadows
‚Ä¢ NO floating objects or physics violations

‚õî PHOTOGRAPHIC TECHNICAL PROHIBITIONS:
‚Ä¢ NO motion blur, camera shake, or focus issues
‚Ä¢ NO lens distortion, chromatic aberration, or optical flaws
‚Ä¢ NO overexposure, underexposure, or blown highlights
‚Ä¢ NO digital noise, grain, or compression artifacts
‚Ä¢ NO color banding, posterization, or color processing errors
‚Ä¢ NO vignetting unless intentional and professional

‚õî SURFACE & MATERIAL ARTIFACT PROHIBITIONS:
‚Ä¢ NO plastic-looking wood or artificial material appearance
‚Ä¢ NO unrealistic reflections or mirror effects
‚Ä¢ NO harsh glare, hotspots, or reflection artifacts
‚Ä¢ NO surface texture errors or material inconsistencies
‚Ä¢ NO scale inconsistencies or proportion distortions
‚Ä¢ NO impossible material combinations or behaviors

‚õî COMPOSITION ARTIFACT PROHIBITIONS:
‚Ä¢ NO multiple instances or duplications of the same product
‚Ä¢ NO repeated patterns or cloned elements
‚Ä¢ NO impossible perspectives or viewing angles
‚Ä¢ NO spatial inconsistencies or depth errors
‚Ä¢ NO lighting direction conflicts or multiple light sources issues
‚Ä¢ NO composition elements that defy physical laws

‚õî DIGITAL PROCESSING PROHIBITIONS:
‚Ä¢ NO social media filters or Instagram-style effects
‚Ä¢ NO HDR over-processing or unnatural color enhancement
‚Ä¢ NO artificial sharpening halos or edge artifacts
‚Ä¢ NO color grading that makes materials look unrealistic
‚Ä¢ NO digital makeup or beauty filter effects
‚Ä¢ NO artificial bokeh or depth effect errors

VALIDATION REQUIREMENT: The final image must appear as if captured with professional photography equipment by an experienced commercial photographer. Any digital artifacts or non-photorealistic elements constitute generation failure.`;
  }

  /**
   * CRITICAL: Placement Enforcement (Issue #4)
   * Intelligent furniture placement with zero-tolerance validation
   */
  private static buildPlacementEnforcement(productIntel: ProductIntelligence): string {
    const placementType = productIntel.placementType;
    
    let placementConstraints = `üö´üèóÔ∏è PLACEMENT ENFORCEMENT - INTELLIGENT POSITIONING CONTROL

DETECTED FURNITURE TYPE: ${productIntel.category.toUpperCase()}
REQUIRED PLACEMENT: ${placementType.toUpperCase().replace('_', ' ')}

`;

    switch (placementType) {
      case 'wall_mounted':
        placementConstraints += `‚õî WALL-MOUNTED FURNITURE ABSOLUTE PROHIBITIONS:
‚Ä¢ ABSOLUTELY NO floor contact - not even partial or implied contact
‚Ä¢ NO legs, supports, feet, or any structural elements touching ground
‚Ä¢ NO desk legs extending to floor for wall-mounted desks
‚Ä¢ NO table legs for wall-mounted tables or surfaces
‚Ä¢ NO pedestals, stands, or floor-based support systems
‚Ä¢ NO free-standing installation when wall mounting is required
‚Ä¢ NO floating appearance without visible mounting system

‚úÖ WALL-MOUNTED REQUIREMENTS:
‚Ä¢ MUST show wall attachment point with appropriate hardware
‚Ä¢ MUST display realistic mounting brackets, cleats, or cantilever system
‚Ä¢ MUST show proper wall surface interaction and attachment
‚Ä¢ MUST maintain clearance beneath product (minimum 5cm)
‚Ä¢ MUST appear securely mounted with weight properly supported
‚Ä¢ MUST show wall material appropriate for mounting system

CRITICAL VALIDATION: Wall-mounted furniture MUST appear to be professionally installed on a wall surface with NO connection to the floor. Any floor contact invalidates the generation.`;
        break;

      case 'floor_standing':
        placementConstraints += `‚õî FLOOR-STANDING FURNITURE PROHIBITIONS:
‚Ä¢ NO floating or suspended appearance unless designed for that
‚Ä¢ NO incomplete floor contact or unstable positioning  
‚Ä¢ NO wall mounting when floor-standing is intended
‚Ä¢ NO tabletop placement for large floor furniture

‚úÖ FLOOR-STANDING REQUIREMENTS:
‚Ä¢ ALL support points MUST make proper floor contact
‚Ä¢ MUST show stable, level positioning appropriate for furniture weight
‚Ä¢ MUST maintain realistic clearances from walls (typically 5-15cm)
‚Ä¢ MUST demonstrate proper weight distribution and stability
‚Ä¢ MUST show appropriate floor material interaction

CRITICAL VALIDATION: Floor-standing furniture MUST show complete structural support through floor contact. Incomplete support or unstable appearance invalidates the generation.`;
        break;

      case 'tabletop':
        placementConstraints += `‚õî TABLETOP FURNITURE PROHIBITIONS:
‚Ä¢ NO floor placement for tabletop-designed furniture
‚Ä¢ NO oversized table surfaces inappropriate for product
‚Ä¢ NO unstable or precarious surface positioning
‚Ä¢ NO surfaces inappropriate for furniture weight or size

‚úÖ TABLETOP REQUIREMENTS:
‚Ä¢ MUST be positioned on appropriately sized supporting surface
‚Ä¢ MUST show stable placement with proper surface contact
‚Ä¢ MUST demonstrate realistic size relationship to supporting surface
‚Ä¢ MUST show appropriate surface material and finish

CRITICAL VALIDATION: Tabletop furniture MUST be placed on an appropriate supporting surface with stable, realistic positioning.`;
        break;

      case 'ceiling_mounted':
        placementConstraints += `‚õî CEILING-MOUNTED FURNITURE PROHIBITIONS:
‚Ä¢ NO floor or wall contact for ceiling-mounted items
‚Ä¢ NO tabletop or surface placement
‚Ä¢ NO invisible suspension without mounting hardware

‚úÖ CEILING-MOUNTED REQUIREMENTS:  
‚Ä¢ MUST show ceiling attachment point and hardware
‚Ä¢ MUST display appropriate suspension system
‚Ä¢ MUST maintain proper hanging height and clearances
‚Ä¢ MUST show secure attachment appropriate for product weight

CRITICAL VALIDATION: Ceiling-mounted furniture MUST appear properly suspended from ceiling with appropriate hardware and no other surface contact.`;
        break;
    }

    return placementConstraints;
  }

  /**
   * CRITICAL: Adherence Enforcement (Issue #5)
   * Strict compliance with user specifications without creative liberties
   */
  private static buildAdherenceEnforcement(specs: ProductSpecs, settings: UiSettings): string {
    return `üö´üéØ SPECIFICATION ADHERENCE ENFORCEMENT - ZERO CREATIVE LIBERTIES

‚õî DESIGN MODIFICATION PROHIBITIONS:
‚Ä¢ NO changes to product design, style, or aesthetic
‚Ä¢ NO alternative color schemes unless specifically requested
‚Ä¢ NO material substitutions or finish modifications
‚Ä¢ NO proportional changes or size modifications
‚Ä¢ NO hardware changes or detail modifications
‚Ä¢ NO stylistic interpretation or artistic license

‚õî SPECIFICATION VIOLATION PROHIBITIONS:
‚Ä¢ NO deviation from stated materials: "${specs.materials}"
‚Ä¢ NO ignoring of product type requirements: "${specs.productType}"
‚Ä¢ NO changes to specified dimensions or proportions
‚Ä¢ NO modifications to additional specifications: "${specs.additionalSpecs || 'None specified'}"
‚Ä¢ NO brand interpretation beyond exact product identity
‚Ä¢ NO feature additions or removals not specified

‚õî SETTING OVERRIDE PROHIBITIONS:
‚Ä¢ Background MUST be: "${settings.backgroundStyle}"
‚Ä¢ Product position MUST be: "${settings.productPosition}"
‚Ä¢ Lighting MUST be: "${settings.lighting.replace('_', ' ')}"
‚Ä¢ Props limited to: ${settings.props.length > 0 ? settings.props.join(', ') : 'NONE'}
${settings.reservedTextZone ? `‚Ä¢ Text zone MUST be reserved: "${settings.reservedTextZone}"` : ''}
${settings.strictMode ? '‚Ä¢ STRICT MODE: Zero tolerance for any deviation' : ''}

‚õî CONTEXTUAL DEVIATION PROHIBITIONS:
‚Ä¢ NO context changes from specified preset requirements
‚Ä¢ NO style mixing between different context types
‚Ä¢ NO format violations for specified context preset
‚Ä¢ NO composition changes that conflict with context requirements

VALIDATION REQUIREMENT: The generated image must exactly match ALL user specifications without any creative interpretation, modification, or enhancement beyond explicit instructions. Any deviation from specifications constitutes generation failure.`;
  }

  /**
   * Context-specific constraint additions
   */
  private static buildContextSpecificConstraints(contextPreset: ContextPreset, settings: UiSettings): string {
    let contextConstraints = `üö´üìã CONTEXT-SPECIFIC CONSTRAINT ENFORCEMENT: ${contextPreset.toUpperCase()}

`;

    switch (contextPreset) {
      case 'packshot':
        contextConstraints += `‚õî PACKSHOT-SPECIFIC PROHIBITIONS:
‚Ä¢ NO environmental elements, rooms, or architectural context
‚Ä¢ NO lifestyle props or contextual staging elements
‚Ä¢ NO background textures, patterns, or visual interest
‚Ä¢ NO environmental lighting (studio lighting only)
‚Ä¢ NO compositional elements beyond product and background
‚Ä¢ NO shadows that create environmental suggestions

‚úÖ PACKSHOT ABSOLUTE REQUIREMENTS:
‚Ä¢ Pure white seamless studio background only
‚Ä¢ Product isolation with no competing elements
‚Ä¢ Professional three-point studio lighting
‚Ä¢ Commercial catalog presentation standards`;
        break;

      case 'lifestyle':
        contextConstraints += `‚õî LIFESTYLE-SPECIFIC PROHIBITIONS:
‚Ä¢ NO unrealistic or impossibly perfect staging
‚Ä¢ NO over-styled or magazine-perfect arrangements
‚Ä¢ NO competing furniture that overshadows main product
‚Ä¢ NO cluttered or chaotic environmental elements
‚Ä¢ NO inappropriate scale between product and environment
‚Ä¢ NO lifestyle elements that distract from product

‚úÖ LIFESTYLE ABSOLUTE REQUIREMENTS:
‚Ä¢ Realistic, achievable interior environment
‚Ä¢ Natural product integration without artificial staging
‚Ä¢ Appropriate architectural context for furniture type
‚Ä¢ Contextual elements enhance rather than compete`;
        break;

      case 'social_media_square':
        contextConstraints += `‚õî SOCIAL MEDIA SQUARE PROHIBITIONS:
‚Ä¢ NO aspect ratio deviation from perfect 1:1 square
‚Ä¢ NO composition that doesn't work in mobile feeds
‚Ä¢ NO overly complex backgrounds unsuitable for social media
‚Ä¢ NO elements that don't translate to small screen viewing

‚úÖ SOCIAL MEDIA SQUARE REQUIREMENTS:
‚Ä¢ Perfect 1:1 aspect ratio composition
‚Ä¢ Mobile-optimized brightness and contrast
‚Ä¢ Social media engagement appropriate presentation`;
        break;

      case 'social_media_story':
        contextConstraints += `‚õî SOCIAL MEDIA STORY PROHIBITIONS:
‚Ä¢ NO aspect ratio deviation from 9:16 vertical format
‚Ä¢ NO product placement that interferes with story interface
‚Ä¢ NO horizontal composition elements
‚Ä¢ NO text overlay zone violations

‚úÖ SOCIAL MEDIA STORY REQUIREMENTS:
‚Ä¢ Perfect 9:16 vertical aspect ratio
‚Ä¢ Product in upper two-thirds of frame
‚Ä¢ Bottom area reserved for story interface and text`;
        break;

      case 'hero':
        contextConstraints += `‚õî HERO BANNER PROHIBITIONS:
‚Ä¢ NO text or graphics embedded in the image
‚Ä¢ NO elements in reserved text overlay zones
‚Ä¢ NO composition unsuitable for website header usage
‚Ä¢ NO busy backgrounds that compete with text readability
${settings.reservedTextZone ? `‚Ä¢ NO elements in ${settings.reservedTextZone} text zone` : ''}

‚úÖ HERO BANNER REQUIREMENTS:
‚Ä¢ Wide banner format suitable for website headers
‚Ä¢ Strategic negative space for text overlay
‚Ä¢ Premium brand presentation quality
‚Ä¢ Dramatic lighting with marketing impact`;
        break;
    }

    return contextConstraints;
  }

  /**
   * Build comprehensive validation requirements
   */
  private static buildValidationRequirements(): string {
    return `üîç COMPREHENSIVE VALIDATION REQUIREMENTS

‚ö° IMMEDIATE DISQUALIFICATION CRITERIA:
Any presence of the following immediately disqualifies the generation:
‚Ä¢ Human elements of any kind (body parts, clothing, accessories, shadows)
‚Ä¢ Irrelevant objects not explicitly approved (cups, books, electronics, etc.)
‚Ä¢ Artificial rendering artifacts (cartoon-like, non-photorealistic)
‚Ä¢ Placement violations for detected furniture type
‚Ä¢ Specification deviations or creative liberties
‚Ä¢ Text, labels, or written content of any kind
‚Ä¢ Multiple product instances or duplications

‚úÖ PRODUCTION QUALITY VALIDATION CHECKLIST:
Before accepting any generation, verify:
‚Ä¢ Professional commercial photography quality achieved
‚Ä¢ All constraint categories fully satisfied
‚Ä¢ Product appears exactly as specified without modifications
‚Ä¢ Placement logic correctly applied for furniture type
‚Ä¢ Material authenticity and surface realism maintained
‚Ä¢ Context preset requirements fully met
‚Ä¢ Background and lighting appropriate for specified context
‚Ä¢ Composition suitable for intended commercial use

üéØ SUCCESS CRITERIA:
The generated image must be immediately ready for:
‚Ä¢ E-commerce product catalogs and listings
‚Ä¢ Professional marketing materials and campaigns
‚Ä¢ Website headers and digital marketing applications
‚Ä¢ Print advertising and promotional materials
‚Ä¢ Brand representation across all commercial channels

FINAL VALIDATION: Only images that pass ALL validation requirements and meet enterprise production standards should be accepted. Any quality issues require immediate regeneration with enhanced constraint emphasis.`;
  }

  /**
   * Get constraint statistics for monitoring and optimization
   */
  static getConstraintStats(
    specs: ProductSpecs,
    contextPreset: ContextPreset,
    settings: UiSettings,
    productIntel: ProductIntelligence
  ): {
    totalConstraints: number;
    absoluteConstraints: number;
    criticalConstraints: number;
    placementSpecific: number;
    contextSpecific: number;
    materialSpecific: number;
  } {
    const constraints = this.buildEnhancedConstraints(specs, contextPreset, settings, productIntel);
    
    return {
      totalConstraints: (constraints.match(/‚õî/g) || []).length,
      absoluteConstraints: (constraints.match(/ABSOLUTE/g) || []).length,
      criticalConstraints: (constraints.match(/CRITICAL/g) || []).length,
      placementSpecific: (constraints.match(/PLACEMENT/g) || []).length,
      contextSpecific: (constraints.match(/CONTEXT/g) || []).length,
      materialSpecific: (constraints.match(/MATERIAL/g) || []).length,
    };
  }
}

/**
 * PRODUCTION CONSTRAINT ENFORCEMENT INTEGRATION
 */

/**
 * Build production-ready constraints for immediate use
 */
export function buildProductionConstraints(
  specs: ProductSpecs,
  contextPreset: ContextPreset,
  settings: UiSettings,
  productIntel: ProductIntelligence
): string {
  return EnhancedConstraintSystem.buildEnhancedConstraints(
    specs,
    contextPreset,
    settings,
    productIntel
  );
}

/**
 * Validate constraint coverage for quality assurance
 */
export function validateConstraintCoverage(
  constraints: string
): {
  isComprehensive: boolean;
  missingCategories: string[];
  coverageScore: number;
} {
  const requiredCategories = [
    'human element prohibition',
    'irrelevant object prevention', 
    'artifact prevention',
    'placement enforcement',
    'specification adherence'
  ];

  const missingCategories: string[] = [];
  let coverageScore = 0;

  const constraintsLower = constraints.toLowerCase();

  if (constraintsLower.includes('human') && constraintsLower.includes('prohibition')) {
    coverageScore += 20;
  } else {
    missingCategories.push('human element prohibition');
  }

  if (constraintsLower.includes('irrelevant') && constraintsLower.includes('object')) {
    coverageScore += 20;
  } else {
    missingCategories.push('irrelevant object prevention');
  }

  if (constraintsLower.includes('artifact') && constraintsLower.includes('prevention')) {
    coverageScore += 20;
  } else {
    missingCategories.push('artifact prevention');
  }

  if (constraintsLower.includes('placement') && constraintsLower.includes('enforcement')) {
    coverageScore += 20;
  } else {
    missingCategories.push('placement enforcement');
  }

  if (constraintsLower.includes('specification') && constraintsLower.includes('adherence')) {
    coverageScore += 20;
  } else {
    missingCategories.push('specification adherence');
  }

  return {
    isComprehensive: coverageScore >= 80,
    missingCategories,
    coverageScore
  };
}